@model IEnumerable<TouristGuide.Models.Attraction>
@{
    ViewBag.Title = "Attractions";
}

<link href="@Url.Content("~/Content/themes/base/jquery.ui.autocomplete.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/themes/base/jquery.ui.all.css")" rel="stylesheet" type="text/css" />

<script type="text/javascript">
    //pagger scrolling and filtering
    var more = true;
    var loading = false;
    var count = 20;
    var start = 0;
    var loaderImg = null;
    var country = '';
    var place = '';
    var attr = '';

    $(document).ready(function () {
        country = $("#country").val();
        place = $("#place").val();
        attr = $("#attraction").val();

        if ($('.post').length < count) {
            more = false;
            HideLoading();
        }
        else {
            ShowLoading();
            $(window).scroll($.proxy(ScrollHandler, this));
        }
    });

    function ShowLoading() {
        loaderImg = $("<div>").addClass("bar").css("clear", "both").css("text-align", "center");
        var img = $("<img>").attr("src", "/Content/images/indicator.gif");
        loaderImg.append(img);
        $("#render").append(loaderImg);
    }

    function HideLoading() {
        $(loaderImg).remove();
    }

    function isScrolledIntoView(elem) {
        var docViewTop = $(window).scrollTop();
        var docViewBottom = docViewTop + $(window).height();

        var elemTop = $(elem).offset().top;
        var elemBottom = elemTop + $(elem).height();

        return ((elemBottom <= docViewBottom) && (elemTop >= docViewTop));
    }

    function ScrollHandler(event) {
        if (isScrolledIntoView(loaderImg) && loading == false) {
            GetPage();
        }
    }

    function GetPage(event) {
        if (more == true) {
            start += count;
            GetAtt();
            loading = true;
        }
    }

    function GetAtt() {
        $.ajax({
            url: '@Url.Action("GetAttractions", "Attraction")',
            type: 'GET',
            contentType: 'application/json',
            data: { country: country, place: place,
                attraction: attr, start: start, count: count
            },
            dataType: 'html',
            success: $.proxy(Results, this)
        });
    }

    function Results(data) {
        if (data != null && data.trim() != '') {
            HideLoading();
            $("#render").append(data);
            if (data.split('<div class="post">').length - 1 < count) {
                more = false;
                HideLoading();
            }
            else {
                ShowLoading();
                loading = false;
            }
        }
        else {
            more = false;
            HideLoading();
        }
    }

</script>
@Html.Partial("Partial/Autocomplete")

@if (Request.IsAuthenticated && HttpContext.Current.User.IsInRole("admin"))
{
    <p>@Html.ActionLink("Add attraction", "Create")</p>
}

<div class="center border-bottom search-cat">
@using (Html.BeginForm())
{
    <text>Country:</text>
    @Html.TextBox("country") 
    <text>City/Region:</text>
    @Html.TextBox("place") 
    <text>Attraction:</text>
    @Html.TextBox("attraction", null, new { @style="width: 150px;" }) 
    <input type="submit" value="Filter" />
}
</div>

@Html.DisplayFor(m => m)
